version: "3.8"

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: xibalba_api
    volumes:
      - ./:/app:cached
    ports:
      - "8001:8001"
    environment:
      - PORT=8001
      - WORKER_SECRET=${WORKER_SECRET:-}
    command: >
      uvicorn 00_xibalba_alpaca/orchestrator/api/main:app
      --host 0.0.0.0 --port 8001 --reload
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:8001/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  hybrid-agent:
    image: node:18
    container_name: xibalba_hybrid_agent
    working_dir: /app
    volumes:
      - ./:/app:cached
      - ./hybrid-queue:/app/hybrid-queue
      - ./hybrid-results:/app/hybrid-results
    environment:
      - HYBRID_QUEUE=${HYBRID_QUEUE:-hybrid-queue}
      - HYBRID_RESULTS=${HYBRID_RESULTS:-hybrid-results}
    command: sh -c "node hybrid-agent/hybrid-agent.js --queue ${HYBRID_QUEUE:-hybrid-queue} --results ${HYBRID_RESULTS:-hybrid-results}"
    restart: unless-stopped
    depends_on:
      - api

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: xibalba_worker
    volumes:
      - ./:/app:cached
      - ./hybrid-queue:/app/hybrid-queue
      - ./hybrid-results:/app/hybrid-results
    environment:
      - API_URL=http://api:8001
      - WORKER_ID=${WORKER_ID:-docker1}
      - HYBRID_QUEUE=${HYBRID_QUEUE:-hybrid-queue}
      - HYBRID_RESULTS=${HYBRID_RESULTS:-hybrid-results}
      - WORKER_SECRET=${WORKER_SECRET:-}
      - HYBRID_SECRET=${HYBRID_SECRET:-}
    command: >
      python3 00_xibalba_alpaca/orchestrator/worker/worker.py
      --api http://api:8001
      --worker-id ${WORKER_ID:-docker1}
      --hybrid-queue ${HYBRID_QUEUE:-hybrid-queue}
      --hybrid-results ${HYBRID_RESULTS:-hybrid-results}
    restart: unless-stopped
    depends_on:
      - api

# Optional named volumes could be used if you prefer not to bind-mount the repo directories:
# volumes:
#   hybrid-queue:
#   hybrid-results:

# Notes:
# - This compose file mounts the repository into each container so you can iterate from your editor (Zed/VS Code).
# - If you prefer isolation, replace the bind mounts with named volumes and remove the :cached hints.
# - Before running, ensure Docker has access to the project folder and create ./hybrid-queue and ./hybrid-results if needed:
#     mkdir -p hybrid-queue hybrid-results
#
# Usage:
#   docker-compose up --build
# To run only a specific service:
#   docker-compose up --build api
