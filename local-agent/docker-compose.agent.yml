version: "3.8"

# Docker Compose snippet to run the local-agent and its simple UI
# - Mounts the repository into the containers so you can edit files in Zed and the containers pick them up
# - Provides persistent named volumes for the queue, results and agent logs so state survives restarts
# - Exposes the UI on localhost:8765 by default
#
# Usage:
#   docker-compose -f local-agent/docker-compose.agent.yml up -d --build
#
# Environment variables you can set in your shell or an .env file:
#   HYBRID_SECRET       - optional secret token agent will validate against .cmd files
#   POLL_INTERVAL       - seconds between queue polls (default: 2)
#   JOB_MAX_SECONDS     - per-job timeout in seconds (default: 300)
#   LOCAL_UID / LOCAL_GID - if you want containers to run files as your host UID/GID (optional)
#

services:
  local-agent:
    image: python:3.11-slim
    container_name: xib_local_agent
    working_dir: /srv/xibalba
    user: "${LOCAL_UID:-1000}:${LOCAL_GID:-1000}"
    volumes:
      - ./:/srv/xibalba:cached
      - local_agent_logs:/srv/xibalba/local-agent-logs
      - hybrid_queue:/srv/xibalba/hybrid-queue
      - hybrid_results:/srv/xibalba/hybrid-results
    environment:
      - HYBRID_SECRET=${HYBRID_SECRET:-}
      - POLL_INTERVAL=${POLL_INTERVAL:-2}
      - JOB_MAX_SECONDS=${JOB_MAX_SECONDS:-300}
    command: >
      bash -lc "python3 local-agent/agent.py --queue hybrid-queue --results hybrid-results
      --poll-interval ${POLL_INTERVAL:-2} --max-seconds ${JOB_MAX_SECONDS:-300}"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "test -d /srv/xibalba/hybrid-queue && test -d /srv/xibalba/hybrid-results || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  local-ui:
    image: python:3.11-slim
    container_name: xib_local_agent_ui
    working_dir: /srv/xibalba
    user: "${LOCAL_UID:-1000}:${LOCAL_GID:-1000}"
    ports:
      - "8765:8765"       # UI: http://localhost:8765/
    volumes:
      - ./:/srv/xibalba:cached
      - local_agent_logs:/srv/xibalba/local-agent-logs
      - hybrid_queue:/srv/xibalba/hybrid-queue
      - hybrid_results:/srv/xibalba/hybrid-results
    environment:
      - HYBRID_SECRET=${HYBRID_SECRET:-}
    command: >
      bash -lc "python3 local-agent/ui_server.py --queue hybrid-queue --results hybrid-results --port 8765"
    restart: unless-stopped
    depends_on:
      - local-agent
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8765/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Named volumes for persistent local state
volumes:
  hybrid_queue:
    driver: local
  hybrid_results:
    driver: local
  local_agent_logs:
    driver: local
