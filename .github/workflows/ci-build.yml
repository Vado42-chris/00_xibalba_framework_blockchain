name: ci-build-client

on:
  pull_request:
  push:
    branches:
      - "salvage/**"

permissions:
  contents: read

jobs:
  build:
    name: Build client (no deploy)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: Locate client directory (root or 00_xibalba_alpaca)
        id: find-client
        shell: bash
        run: |
          set -euo pipefail

          # Allow an explicit override for CI or debugging
          if [ -n "${CI_CLIENT_DIR-}" ]; then
            if [ -d "${CI_CLIENT_DIR}" ]; then
              echo "client_dir=${CI_CLIENT_DIR}" >> "$GITHUB_OUTPUT"
              echo "Found client via CI_CLIENT_DIR override: ${CI_CLIENT_DIR}"
              exit 0
            else
              echo "CI_CLIENT_DIR is set but directory not found: ${CI_CLIENT_DIR}" >&2
            fi
          fi

          # Preferred locations in order
          CANDIDATES=("client" "00_xibalba_alpaca/client" "00_xibalba_alpaca/client" "./client")
          FOUND=""
          for p in "${CANDIDATES[@]}"; do
            if [ -d "$p" ]; then
              FOUND="$p"
              break
            fi
          done

          if [ -n "$FOUND" ]; then
            echo "client_dir=$FOUND" >> "$GITHUB_OUTPUT"
            echo "Client directory located: $FOUND"
          else
            # As a secondary detection, check for package.json in the directories (some repos keep package.json but no node_modules yet)
            for p in "client" "00_xibalba_alpaca/client" "."; do
              if [ -f "$p/package.json" ]; then
                echo "client_dir=$p" >> "$GITHUB_OUTPUT"
                echo "Client package.json found in: $p"
                FOUND="$p"
                break
              fi
            done
          fi

          if [ -z "${FOUND}" ]; then
            echo "client_dir=" >> "$GITHUB_OUTPUT"
            echo "No client directory found; client build steps will be skipped."
          fi

      - name: Install & build client if found
        if: ${{ steps.find-client.outputs.client_dir != '' }}
        shell: bash
        run: |
          set -euo pipefail

          CLIENT_DIR="${{ steps.find-client.outputs.client_dir }}"
          echo "Using client directory: $CLIENT_DIR"
          ls -la "$CLIENT_DIR" || true

          cd "$CLIENT_DIR"

          # Show environment
          echo "Node version:"
          node -v || true
          echo "npm version:"
          npm -v || true

          # Prefer lockfile installs for reproducibility
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "Lockfile found (package-lock.json/npm-shrinkwrap.json) — using npm ci"
            npm ci --silent
          elif [ -f yarn.lock ]; then
            echo "yarn.lock found — using yarn install"
            if command -v yarn >/dev/null 2>&1; then
              yarn install --silent
            else
              echo "yarn not available; falling back to npm install"
              npm install --silent --no-audit --no-fund
            fi
          elif [ -f pnpm-lock.yaml ]; then
            echo "pnpm lockfile found — using pnpm install"
            if command -v pnpm >/dev/null 2>&1; then
              pnpm install --silent
            else
              echo "pnpm not available; falling back to npm install"
              npm install --silent --no-audit --no-fund
            fi
          elif [ -f package.json ]; then
            echo "No lockfile found; using npm install (non-CI) to ensure dependencies are present"
            npm install --silent --no-audit --no-fund
          else
            echo "No package.json found in $CLIENT_DIR; skipping install/build"
            exit 0
          fi

          # Run build if script exists; don't fail the whole job if build script is absent — we just list contents
          if npm run | sed -n '1,200p' | grep -q "build"; then
            echo "Running build (npm run build)..."
            npm run build --if-present
          else
            echo "No build script defined (npm run build). Skipping build step."
          fi

          # Provide visibility into the typical publish locations
          echo "After build: listing common output directories"
          for d in dist build client/dist client/build; do
            if [ -d "$d" ]; then
              echo "Contents of $d:"
              ls -la "$d" || true
            fi
          done

      - name: Skip message when client not present
        if: ${{ steps.find-client.outputs.client_dir == '' }}
        run: |
          echo "Client directory was not found in either 'client' or '00_xibalba_alpaca/client'."
          echo "This CI job will skip client build steps to avoid failing for layout differences."
          echo "If you want CI to build the client, place it in 'client/' or '00_xibalba_alpaca/client', or set CI_CLIENT_DIR to the correct path."

      - name: Show first 200 lines of build output (if any)
        if: always()
        run: |
          echo "Build finished (or skipped). Check earlier logs for install/build output."
          # Try to display a common build log file if present (legacy)
          if [ -f build.log ]; then
            echo "=== build.log (first 200 lines) ==="
            sed -n '1,200p' build.log || true
          else
            echo "No build.log found in workspace."
          fi
